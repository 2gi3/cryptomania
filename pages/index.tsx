// @ts-nocheck

import type { NextPage } from 'next'
import Head from 'next/head'
import Image from 'next/image'
import React, { useEffect, useState } from 'react'
import { AppProps } from 'next/app'
import Buttons from '../components/Buttons'
import GJNumbersView from '../components/GJNumbersView'
import NamedColors from '../components/NamedColors'
import WorldPopulation from '../components//WorldPopulation'
import ScatterPlot from '../components/ScatterPlot'
import TemperatureLineChart from '../components/TemperatureLineChart'

export const getServerSideProps = async () => {
  const results = await Promise.all([
    fetch('https://www.bitstamp.net/api/v2/ticker/').then((res) => res.json()),
    fetch('https://api-pub.bitfinex.com/v2/tickers?symbols=tBTCUSD').then(
      (res) => res.json()
    ),
    fetch('https://api.coinbase.com/v2/exchange-rates?currency=BTC').then(
      (res) => res.json()
    ),
    fetch('https://www.bitstamp.net/api/v2/trading-pairs-info/').then((res) =>
      res.json()
    ),
  ]).catch((err) => console.log(err))

  return {
    props: {
      bitstampData: results[0],
      coinbaseData: results[2].data,
      finexData: results[1],
      buttonsData: results[3],
    },
  }
}

export const Context = React.createContext('BTC/USD')

const Home: NextPage = ({
  buttonsData,
  bitstampData,
  coinbaseData,
  finexData,
}) => {
  const [selectedPair, setSelectedPair] = useState('BTC/USD')

  const coinbaseLast = Number(coinbaseData.rates.USD)
  const bitstampUSD = bitstampData.find((obj) => {
    return obj.pair === 'BTC/USD'
  })
  const bitstampLast = Number(bitstampUSD.last)
  const finexLast = finexData[0][1]

  const calculateAverageLast = (
    a: number,
    b: number,
    c: number
  ): number | string => {
    let array = []
    typeof a === 'number' ? array.push(a) : null
    typeof b === 'number' ? array.push(b) : null
    typeof c === 'number' ? array.push(c) : null
    const sum = array.reduce((a, b) => a + b, 0)
    const average = sum / array.length
    if (array.length > 0) {
      return average
    } else {
      return 'Data not available at this time'
    }
  }

  const averageLast = calculateAverageLast(
    finexLast,
    bitstampLast,
    coinbaseLast
  )
  return (
    <div>
      <Head>
        <title>Cryptomaina</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <header className="w-full h-10 flex justify-center items-center">
        <h1 className="text-xl font-bold underline">Cryptomaina</h1>
      </header>
      <main>
        <div className="flex flex-col lg:flex-row bg-gray-200 justify-center">
          <section className="w-full bg-primary flex flex-col justify-center items-center h-60 p-10 min-w-min ">
            <h1>Average ticker values</h1>
            <h2>&rdquo;Last&rdquo; value for BTC/USD</h2>
            <p>{averageLast}</p>
          </section>
          <section className="bg-yellow-300 ">
            <div>
              <Buttons pairs={buttonsData} />
            </div>
          </section>
        </div>
        <section>
          <div className="bg-green-300">
            <GJNumbersView data={bitstampData} />
          </div>
        </section>
      </main>

      <footer>
        <NamedColors />
        <ScatterPlot />
        <WorldPopulation />
        <TemperatureLineChart />
      </footer>
    </div>
  )
}

export default Home
